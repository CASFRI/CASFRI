---  
title: "NFL Attributes"
output:  
  html_document:  
    code_folding: hide
    toc: true
    toc_float:
      collapsed: false
    css: styles.css
---  

<br>

# What's new

May 14, 2019

  * All NFL attributes are ready to reviewed.

<br>

# Overview

  * Create NFL attributes for polygons where for_mgmt_land_base_ind=="N". This attribute is new (see PDF) and should be preferable to using crown_closure (as suggested by CASFRI or species_cd_1 as used in Perl code).
  * The key FRI attributes are for "V" and "I" are land_cover_class_cd_1, non_veg_cover_type1, and bclcs_level4
  * The key FRI attributes are for "F" are non_productive_descriptor_cd and bclcs_level4
  * The order FRI attributes are processed is important; a polygon can have a value for 1 or 2 of those attributes, they are not exclusive.
  * The fri and cas parameters in the mapvalues function (see code sections below) are specific to the FRI and CAS attributes and are described in the accompanying spreadsheet (bc08_nfl.xlsx).
  * <a target="_blank" href="">Click here for additional notes on BC inventories.</a>

<br>

# Attributes translation

```{r echo=TRUE, message=FALSE, warning=FALSE}  

# NFL codes
lcc1 = read_excel("bc08_nfl.xlsx", sheet="land_cover_class_cd_1")
bclcs4 = read_excel("bc08_nfl.xlsx", sheet="bclcs_level_4")
nveg1 = read_excel("bc08_nfl.xlsx", sheet="non_veg_cover_type_1")
nprod = read_excel("bc08_nfl.xlsx", sheet="non_productive_descriptor_cd")

x = mutate(x, 

  # Initialize CAS attributes
  non_for_veg="NULL_VALUE", nat_non_veg="NULL_VALUE", non_for_anth="NULL_VALUE", un_prod_for="NULL_VALUE",

  # Process where inventory_standard_cd = "V" or "I" and for_mgmt_land_base_ind=="N"
  # --------------------------------------------------------------------------------

  # Non-forested vegetated (land_cover_class_cd_1 THEN bclcs_level_4)
  non_for_veg = if_else((inventory_standard_cd=="V" | inventory_standard_cd=="I") & (for_mgmt_land_base_ind=="N" & !is.na(land_cover_class_cd_1)), 
                if_else(land_cover_class_cd_1 %in% lcc1$FRI[lcc1$NFV==1], mapvalues(land_cover_class_cd_1,lcc1$FRI[lcc1$NFV==1],lcc1$CAS[lcc1$NFV==1]), "NULL_VALUE"), "NULL_VALUE"),
  non_for_veg = if_else((inventory_standard_cd=="V" | inventory_standard_cd=="I") & (for_mgmt_land_base_ind=="N" & !is.na(bclcs_level_4)) & is.na(non_for_veg),
                if_else(bclcs_level_4 %in% bclcs4$FRI[bclcs4$NFV==1], mapvalues(bclcs_level_4,bclcs4$FRI[bclcs4$NFV==1],bclcs4$CAS[bclcs4$NFV==1]), non_for_veg), non_for_veg),

  # Non-vegetated natural (non_veg_cover_type_1 THEN land_cover_class_cd_1 THEN bclcs_level_4)
  nat_non_veg = if_else((inventory_standard_cd=="V" | inventory_standard_cd=="I") & (for_mgmt_land_base_ind=="N" & !is.na(non_veg_cover_type_1)), 
                if_else(non_veg_cover_type_1 %in% nveg1$FRI[nveg1$NNV==1], mapvalues(non_veg_cover_type_1,nveg1$FRI[nveg1$NNV==1],nveg1$CAS[nveg1$NNV==1]), "NULL_VALUE"), "NULL_VALUE"),
  nat_non_veg = if_else((inventory_standard_cd=="V" | inventory_standard_cd=="I") & (for_mgmt_land_base_ind=="N" & !is.na(land_cover_class_cd_1)) & is.na(nat_non_veg), 
                if_else(land_cover_class_cd_1 %in% lcc1$FRI[lcc1$NNV==1], mapvalues(land_cover_class_cd_1,lcc1$FRI[lcc1$NNV==1],lcc1$CAS[lcc1$NNV==1]), nat_non_veg), nat_non_veg),
  nat_non_veg = if_else((inventory_standard_cd=="V" | inventory_standard_cd=="I") & (for_mgmt_land_base_ind=="N" & !is.na(bclcs_level_4)) & is.na(nat_non_veg),
                if_else(bclcs_level_4 %in% bclcs4$FRI[bclcs4$NNV==1], mapvalues(bclcs_level_4,bclcs4$FRI[bclcs4$NNV==1],bclcs4$CAS[bclcs4$NNV==1]), nat_non_veg), nat_non_veg),

  # Non-vegetated anthropogenic(non_veg_cover_type_1 THEN land_cover_class_cd_1)
  non_for_anth = if_else((inventory_standard_cd=="V" | inventory_standard_cd=="I") & (for_mgmt_land_base_ind=="N" & !is.na(non_veg_cover_type_1)),
                 if_else(non_veg_cover_type_1 %in% nveg1$FRI[nveg1$NFA==1], mapvalues(non_veg_cover_type_1,nveg1$FRI[nveg1$NFA==1],nveg1$CAS[nveg1$NFA==1]), "NULL_VALUE"), "NULL_VALUE"),
  non_for_anth = if_else((inventory_standard_cd=="V" | inventory_standard_cd=="I") & (for_mgmt_land_base_ind=="N" & !is.na(land_cover_class_cd_1)) & is.na(non_for_anth), 
                 if_else(land_cover_class_cd_1 %in% lcc1$FRI[lcc1$NFA==1], mapvalues(land_cover_class_cd_1,lcc1$FRI[lcc1$NFA==1],lcc1$CAS[lcc1$NFA==1]), non_for_anth), non_for_anth),

  # Process where inventory_standard_cd=="F" and for_mgmt_land_base_ind=="N"
  # ------------------------------------------------------------------------

  # Non-forested vegetated (non_productive_descriptor_cd THEN bclcs_level_4)
  non_for_veg = if_else(inventory_standard_cd=="F" & for_mgmt_land_base_ind=="N" & !is.na(non_productive_descriptor_cd), 
                if_else(non_productive_descriptor_cd %in% nprod$FRI[nprod$NFV==1], mapvalues(non_productive_descriptor_cd,nprod$FRI[nprod$NFV==1],nprod$CAS[nprod$NFV==1]), "NULL_VALUE"), non_for_veg),
  non_for_veg = if_else(inventory_standard_cd=="F" & for_mgmt_land_base_ind=="N" & !is.na(bclcs_level_4) & is.na(non_for_veg),
                if_else(bclcs_level_4 %in% bclcs4$FRI[bclcs4$NFV==1], mapvalues(bclcs_level_4,bclcs4$FRI[bclcs4$NFV==1],bclcs4$CAS[bclcs4$NFV==1]), non_for_veg), non_for_veg),

  # Non-vegetated natural (non_productive_descriptor_cd THEN bclcs_level_4)
  nat_non_veg = if_else(inventory_standard_cd=="F" & for_mgmt_land_base_ind=="N" & !is.na(non_productive_descriptor_cd), 
                if_else(non_productive_descriptor_cd %in% nprod$FRI[nprod$NNV==1], mapvalues(non_productive_descriptor_cd,nprod$FRI[nprod$NNV==1],nprod$CAS[nprod$NNV==1]), "NULL_VALUE"), nat_non_veg),
  nat_non_veg = if_else(inventory_standard_cd=="F" & for_mgmt_land_base_ind=="N" & !is.na(bclcs_level_4) & is.na(nat_non_veg), 
                if_else(bclcs_level_4 %in% bclcs4$FRI[bclcs4$NNV==1], mapvalues(bclcs_level_4,bclcs4$FRI[bclcs4$NNV==1],bclcs4$CAS[bclcs4$NNV==1]), nat_non_veg), nat_non_veg),
  
  # Non-vegetated anthropogenic(non_productive_descriptor_cd)
  non_for_anth = if_else(inventory_standard_cd=="F" & for_mgmt_land_base_ind=="N" & !is.na(non_productive_descriptor_cd),
                 if_else(non_productive_descriptor_cd %in% nprod$FRI[nprod$NFA==1], mapvalues(non_productive_descriptor_cd,nprod$FRI[nprod$NFA==1],nprod$CAS[nprod$NFA==1]), "NULL_VALUE"), non_for_anth)
)
```

## nat_non_veg {.tabset}

### RAWFRI

nat_non_veg is generated from multiple attributes.

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["nat_non_veg"], graph.col=FALSE, max.distinct.values=99)
```

## non_for_anth {.tabset}

### RAWFRI

non_for_anth is generated from multiple attributes.

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["non_for_anth"], graph.col=FALSE, max.distinct.values=99)
```

## non_for_veg {.tabset}

### RAWFRI

non_for_veg is generated from multiple attributes.

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["non_for_veg"], graph.col=FALSE, max.distinct.values=99)
```

## soil_moist_reg {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, nfl_soil_moist_reg = case_when(
    (!nat_non_veg=="NULL_VALUE" | !non_for_anth=="NULL_VALUE" | !non_for_veg=="NULL_VALUE") & is.na(soil_moisture_regime_1) ~ "NULL_VALUE",
    (!nat_non_veg=="NULL_VALUE" | !non_for_anth=="NULL_VALUE" | !non_for_veg=="NULL_VALUE") & str_trim(soil_moisture_regime_1)=="" ~ "EMPTY_STRING",
    (!nat_non_veg=="NULL_VALUE" | !non_for_anth=="NULL_VALUE" | !non_for_veg=="NULL_VALUE") & soil_moisture_regime_1 %in% c(0,1,2) ~ "D",
    (!nat_non_veg=="NULL_VALUE" | !non_for_anth=="NULL_VALUE" | !non_for_veg=="NULL_VALUE") & soil_moisture_regime_1 %in% c(3,4) ~ "F",
    (!nat_non_veg=="NULL_VALUE" | !non_for_anth=="NULL_VALUE" | !non_for_veg=="NULL_VALUE") & soil_moisture_regime_1 %in% c(5,6) ~ "M",
    (!nat_non_veg=="NULL_VALUE" | !non_for_anth=="NULL_VALUE" | !non_for_veg=="NULL_VALUE") & soil_moisture_regime_1 %in% c(7,8) ~ "W",
    TRUE                      ~ "NULL_VALUE"))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$soil_moisture_regime_1[!x$nfl_soil_moist_reg=="NULL_VALUE"], graph.col=FALSE, max.distinct.values=99)
```
### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["nfl_soil_moist_reg"], graph.col=FALSE, max.distinct.values=99)
```

## structure_per {.tabset}

CAS_04 has one distinct value for this attribute: -8888

### RAWFRI

### CASFRI

Use null value integer error code: -8887

## crown_closure_upper {.tabset}

CAS_04 has one distinct value for this attribute: -1111. However, this can be calculated from crown_closure for non-forested polygons.

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, nfl_crown_closure_upper = if_else((!nat_non_veg=="NULL_VALUE" | !non_for_anth=="NULL_VALUE" | !non_for_veg=="NULL_VALUE"), as.numeric(crown_closure), as.numeric(-8888)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$crown_closure[!x$nfl_crown_closure_upper=="NULL_VALUE"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["nfl_crown_closure_upper"], graph.col=FALSE, max.distinct.values=99)
```

## crown_closure_lower {.tabset}

CAS_04 has one distinct value for this attribute: -1111. However, this can be calculated from crown_closure for non-forested polygons.

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, nfl_crown_closure_lower = if_else((!nat_non_veg=="NULL_VALUE" | !non_for_anth=="NULL_VALUE" | !non_for_veg=="NULL_VALUE"), as.numeric(crown_closure), as.numeric(-8888)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$crown_closure[!x$nfl_crown_closure_lower=="NULL_VALUE"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["nfl_crown_closure_lower"], graph.col=FALSE, max.distinct.values=99)
```

## height_upper {.tabset}

CAS_04 has one distinct value for this attribute: -1111. However, this can be calculated from crown_closure for non-forested polygons.

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, nfl_height_upper = if_else((!nat_non_veg=="NULL_VALUE" | !non_for_anth=="NULL_VALUE" | !non_for_veg=="NULL_VALUE"), as.numeric(proj_height_1), as.numeric(-8888)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$proj_height_1[!x$nfl_height_upper==-8888], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["nfl_height_upper"], graph.col=FALSE, max.distinct.values=99)
```

## height_lower {.tabset}

CAS_04 has one distinct value for this attribute: -1111. However, this can be calculated from crown_closure for non-forested polygons.

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, nfl_height_lower = if_else((!nat_non_veg=="NULL_VALUE" | !non_for_anth=="NULL_VALUE" | !non_for_veg=="NULL_VALUE"), as.numeric(proj_height_1), as.numeric(-8888)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$proj_height_1[!x$nfl_height_lower==-8888], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["nfl_height_lower"], graph.col=FALSE, max.distinct.values=99)
```
