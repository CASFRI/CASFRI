---  
title: "LYR Attributes"
output:  
  html_document:  
    code_folding: hide
    toc: true
    toc_float:
      collapsed: false
    css: styles.css
---  

<br>

# What's new

  * First version created on 2019-06-05

<br>

# Overview

  * The NB01 FRI data includes two layers which will need to be split and appended (see below).
  * The CAS_04 NB_0001.lyr file had several problems, so prior to using it I made the following modifications:
    * replaced all ",," with ","
    * deleted 4 records with no layer 2 information
        NB_0001-xxFOREST_NONFOR-xxxxxxxxxx-0045270145-0387023
        NB_0001-xxFOREST_NONFOR-xxxxxxxxxx-0052412905-0508761
        NB_0001-xxFOREST_NONFOR-xxxxxxxxxx-0052422602-0512802
        NB_0001-xxFOREST_NONFOR-xxxxxxxxxx-0050408144-0515168
    * partially fixed 3 records using rawfri
        NB_0001-xxFOREST_NONFOR-xxxxxxxxxx-0047375524-0357987 (layer 2)
        NB_0001-xxFOREST_NONFOR-xxxxxxxxxx-0052422602-0526925 (layer 2)
        NB_0001-xxFOREST_NONFOR-xxxxxxxxxx-0050405790-0530309 (layer 2)
    * this still leaves a discrepancy of 1 layer 2 polygon

<br>

# Attributes

We first split the source data into 2 layers:
  * layer 1 = all of the records
  * layer 2 = all non-null l2* records

Then we bind the two into one larger table.

```{r echo=FALSE, message=FALSE, warning=FALSE}  
source("_car.R")
x4 = read_csv("../../vernier/nb01/data/NB_0001_fixed.lyr")
x = friConnect("nb01")
x1 = x %>% mutate(lyr=1)
x2 = filter(x, !is.na(l2s1)) %>% mutate(lyr=2)
#x2 = filter(x, !is.na(l2s1) | l2cc>0) %>% mutate(lyr=2)
x = bind_rows(x1, x2)
```

## soil_moist_reg {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, soil_moist_reg="NOT_APPLICABLE")
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x[""], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4["SOIL_MOIST_REG"], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["soil_moist_reg"], graph.col=FALSE, max.distinct.values=99)
```

## structure_per {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, structure_per=as.integer(-8887))
```

### RAWFRI


### CAS_04


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4["STRUCTURE_PER"], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["structure_per"], graph.col=FALSE, max.distinct.values=99)
```

## layer {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, layer=as.integer(lyr))
```

### RAWFRI

### CAS_04

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4["LAYER"], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["layer"], graph.col=FALSE, max.distinct.values=99)
```

## layer_rank {.tabset}

  * CAS_04 has 2 values for this attribute: 1 and 2. However, it's not clear what the source attribute is to generate this.

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, layer_rank=as.integer(lyr))
```

### RAWFRI

### CAS_04


```{r echo=FALSE, message=FALSE, warning=FALSE}
dfSummary(x4["LAYER_RANK"], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["layer_rank"], graph.col=FALSE, max.distinct.values=99)
```

## crown_closure (layer 1) {.tabset}

  * There is one polygon with a value of 6 (not in CASFRI appendix) and several with values of 0
  * In Perl code, 6 is combined with 5
  * CASFRI specs have first class as 10-30 but CAS_04 has 11-30, which I've applied
  * Check what the true class intervals really should be and if 6 is valid
  * CAS_04 has lumped all values of 0 or NaN into cc_lower=1 and cc_higher=10 [this can't be right!?]
  * Also, check into the FRI classes 61, 62, etc.
  * Even though I've added values 61-64, they don't occur in the forest database

```{r echo=TRUE, message=FALSE, warning=FALSE}  
friList =      c(1,2,3,4,5,6,61,62,63,64)
casListLower = c(11,31,51,71,91,91,11,31,51,71)
casListUpper = c(30,50,70,90,100,100,30,50,70,90)
x = mutate(x,
    crown_closure_lower=if_else(
    lyr==1, 
      case_when(
        is.na(l1cc) ~ as.integer(-8888),
        !l1cc %in% friList ~ as.integer(-9999),
        TRUE ~ as.integer(mapvalues(l1cc, friList, casListLower))),
      case_when(
        is.na(l2cc) ~ as.integer(-8888),
        !l2cc %in% friList ~ as.integer(-9999),
        TRUE ~ as.integer(mapvalues(l2cc, friList, casListLower)))),
    crown_closure_upper=if_else(
    lyr==1, 
      case_when(
        is.na(l1cc) ~ as.integer(-8888),
        !l1cc %in% friList ~ as.integer(-9999),
        TRUE ~ as.integer(mapvalues(l1cc, friList, casListUpper))),
      case_when(
        is.na(l2cc) ~ as.integer(-8888),
        !l2cc %in% friList ~ as.integer(-9999),
        TRUE ~ as.integer(mapvalues(l2cc, friList, casListUpper)))))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$l1cc[x$lyr==1], graph.col=FALSE, max.distinct.values=101)
```

### CAS_04 (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$CROWN_CLOSURE_LOWER[x4$LAYER==1], graph.col=FALSE, max.distinct.values=101)
```

### CAS_05 (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$crown_closure_lower[x$lyr==1], graph.col=FALSE, max.distinct.values=101)
```

### CAS_04 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$CROWN_CLOSURE_UPPER[x4$LAYER==1], graph.col=FALSE, max.distinct.values=101)
```

### CAS_05 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$crown_closure_upper[x$lyr==1], graph.col=FALSE, max.distinct.values=101)
```

## crown_closure (layer 2) {.tabset}

  * See notes for layer 1

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$l2cc[x$lyr==2], graph.col=FALSE, max.distinct.values=101)
```

### CAS_04 (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$CROWN_CLOSURE_LOWER[x4$LAYER==2], graph.col=FALSE, max.distinct.values=101)
```

### CAS_05 (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$crown_closure_lower[x$lyr==2], graph.col=FALSE, max.distinct.values=101)
```

### CAS_04 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$CROWN_CLOSURE_UPPER[x4$LAYER==2], graph.col=FALSE, max.distinct.values=101)
```

### CAS_05 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$crown_closure_upper[x$lyr==2], graph.col=FALSE, max.distinct.values=101)
```


## height (layer 1) {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x,
    height_lower=if_else(
    lyr==1, 
      case_when(
        is.na(l1ht) ~ -8888,
        l1ht < 0.1 | l1ht > 100 ~ -9999,
        TRUE ~ l1ht),
      case_when(
        is.na(l2ht) ~ -8888,
        l2ht < 0.1 | l2ht > 100 ~ -9999,
        TRUE ~ l2ht)),
    height_upper=height_lower)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$l1ht[x$lyr==1], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04 (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$HEIGHT_LOWER[x4$LAYER==1], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05 (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$height_lower[x$lyr==1], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$HEIGHT_UPPER[x4$LAYER==1], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$height_upper[x$lyr==1], graph.col=FALSE, max.distinct.values=99)
```

## height (layer 2) {.tabset}

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$l1ht[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04 (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$HEIGHT_LOWER[x4$LAYER==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05 (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$height_lower[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$HEIGHT_UPPER[x4$LAYER==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$height_upper[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

## species_1-10 (layer 1) {.tabset}

  * The attributes species_1 - species_6 use a lookup table to translate species codes to the CASFRI standard. Here, we demonstrate the code for species_1 only since the same procedure is used for the other species.

```{r echo=TRUE, message=FALSE, warning=FALSE}  
sppList = read_csv("../../translation/tables/lookup/nb_nbi01_species.csv")
x = mutate(x,
    species_1=if_else(
    lyr==1, 
      case_when(
        is.na(l1s1) ~ "NULL_VALUE",
        str_trim(l1s1)=="" ~ "EMPTY_STRING",
        !l1s1 %in% sppList$SOURCE_VAL ~ "NOT_IN_SET",
        TRUE ~ mapvalues(l1s1, sppList$SOURCE_VAL, sppList$SPEC1)),
      case_when(
        is.na(l2s1) ~ "NULL_VALUE",
        str_trim(l2s1)=="" ~ "EMPTY_STRING",
        !l2s1 %in% sppList$SOURCE_VAL ~ "NOT_IN_SET",
        TRUE ~ mapvalues(l2s1, sppList$SOURCE_VAL, sppList$SPEC1))
    )
)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$l1s1[x$lyr==1], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$SPECIES_1[x4$LAYER==1], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$species_1[x$lyr==1], graph.col=FALSE, max.distinct.values=99)
```

## species_1-10 (layer 2) {.tabset}

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$l1s1[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$SPECIES_1[x4$LAYER==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$species_1[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

## species_per_1-10 (layer 1) {.tabset}

  * The attributes species_per_1 - species_per_6 are simply copied from the attributes species_pct_1 - species_pct_6
  * There are some obvious problems with CAS_04 which contains a mix of numbers and species codes

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x,
    species_per_1=if_else(
    lyr==1, 
      case_when(
        is.na(l1pr1) ~ -8888,
        l1pr1 < 0 | l1pr1 > 100 ~ -9999,
        TRUE ~ l1pr1),
      case_when(
        is.na(l2pr1) ~ -8888,
        l2pr1 < 0 | l2pr1 > 100 ~ -9999,
        TRUE ~ l2pr1)
    )
)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$l1pr1[x$lyr==1], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$SPECIES_PER_1[x4$LAYER==1], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$species_per_1[x$lyr==1], graph.col=FALSE, max.distinct.values=99)
```

## species_per_1-10 (layer 2) {.tabset}

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$l1pr1[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$SPECIES_PER_1[x4$LAYER==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$species_per_1[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

## productive_for (layer 1) {.tabset}

  * Not well documented or coded... and CAS_04 and CAS_05 are far apart!
  * We need to go over the rules carefully.

```{r echo=TRUE, message=FALSE, warning=FALSE}  
#x = mutate(x, productive_for=if_else(!is.na(l1trt) & l1trt=="CC","PF", productive_for))
x = mutate(x,
    productive_for=if_else(
    lyr==1, 
      case_when(
        (crown_closure_lower %in% c(-8888,-9999) | height_lower==-9999) | (fst==0 & (!str_trim(l1trt)=="" | !l1trt=="CC")) ~ "PP",
        TRUE ~ "PF"),
      case_when(
        (crown_closure_lower %in% c(-8888,-9999) | height_lower==-9999) | (fst==0 & (!str_trim(l2trt)=="" | !l2trt=="CC")) ~ "PP",
        TRUE ~ "PF")
    )
)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x[""], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$PRODUCTIVE_FOR[x4$LAYER==1], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$productive_for[x$lyr==1], graph.col=FALSE, max.distinct.values=99)
```

## productive_for (layer 2) {.tabset}

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x[""], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$PRODUCTIVE_FOR[x4$LAYER==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$productive_for[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

## origin (layer 1) {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}
x = mutate(x,
    origin_lower=if_else(
    lyr==1, 
      case_when(
        is.na(l1estyr) ~ -8888,
        l1estyr==0 ~ -9999,
        TRUE ~ l1estyr),
      case_when(
        is.na(l2estyr) ~ -8888,
        l2estyr==0 ~ -9999,
        TRUE ~ l2estyr)),
    origin_upper=origin_lower)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$l1estyr[x$lyr==1], graph.col=FALSE, max.distinct.values=999)
```

### CAS_04 (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$ORIGIN_LOWER[x4$LAYER==1], graph.col=FALSE, max.distinct.values=999)
```

### CAS_05 (lower)


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$origin_lower[x$lyr==1], graph.col=FALSE, max.distinct.values=999)
```

### CAS_04 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$ORIGIN_UPPER[x4$LAYER==1], graph.col=FALSE, max.distinct.values=999)
```

### CAS_05 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$origin_upper[x$lyr==1], graph.col=FALSE, max.distinct.values=999)
```

## origin (layer 2) {.tabset}

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$l1estyr[x$lyr==2], graph.col=FALSE, max.distinct.values=999)
```

### CAS_04 (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$ORIGIN_LOWER[x4$LAYER==2], graph.col=FALSE, max.distinct.values=999)
```

### CAS_05 (lower)


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$origin_lower[x$lyr==2], graph.col=FALSE, max.distinct.values=999)
```

### CAS_04 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$ORIGIN_UPPER[x4$LAYER==2], graph.col=FALSE, max.distinct.values=999)
```

### CAS_05 (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$origin_upper[x$lyr==2], graph.col=FALSE, max.distinct.values=999)
```

## site_class (layer 1) {.tabset}

  * CASFRI specs (appendix 11) states there is no field for site, however sitei exists and was used in CAS_04

```{r echo=TRUE, message=FALSE, warning=FALSE}  
friList = c("D","F","P","W")
casList = c("P","P","P","P")
x = mutate(x,
    site_class=if_else(
    lyr==1, 
      case_when(
        is.na(sitei) ~ "NULL_VALUE",
        !sitei %in% friList ~ "NOT_IN_SET",
        TRUE ~ mapvalues(sitei, friList, casList)),
      case_when(
        is.na(sitei) ~ "NULL_VALUE",
        !sitei %in% friList ~ "NOT_IN_SET",
        TRUE ~ mapvalues(sitei, friList, casList))))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$sitei[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$SITE_CLASS[x4$LAYER==1], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$site_class[x$lyr==1], graph.col=FALSE, max.distinct.values=99)
```

## site_class (layer 2) {.tabset}

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$sitei[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4$SITE_CLASS[x4$LAYER==2], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x$site_class[x$lyr==2], graph.col=FALSE, max.distinct.values=99)
```

## site_index {.tabset}

  * CASFRI specs (appendix 11) states that there is no field for site

```{r echo=TRUE, message=FALSE, warning=FALSE}
x = mutate(x, site_index=-8887)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x[""], graph.col=FALSE, max.distinct.values=99)
```

### CAS_04

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x4["SITE_INDEX"], graph.col=FALSE, max.distinct.values=99)
```

### CAS_05


```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["site_index"], graph.col=FALSE, max.distinct.values=99)
```
