---  
title: "LYR Attributes"
output:  
  html_document:  
    code_folding: hide
    toc: true
    toc_float:
      collapsed: false
    css: styles.css
---  

<br>

# What's new

  * Updated 2019-05-23

<br>

# Overview

  * See comments under individual attribute heading

<br>

# Attributes

## soil_moist_reg {.tabset}

  * mixed case where, presumably, should be all lower case i.e., m/M based on random sample of 10,000 records

```{r echo=TRUE, message=FALSE, warning=FALSE}  
friList = c('a','A','d','D','m','M','w','W')
casList = c('A','A','D','D','F','F','W','W')
x = mutate(x, soil_moist_reg=if_else(moisture==" ", "NULL_VALUE", mapvalues(moisture, friList, casList)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["moisture"], graph.col=FALSE, max.distinct.values=99)
```
### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["soil_moist_reg"], graph.col=FALSE, max.distinct.values=99)
```

## structure_per {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, structure_per=if_else(std_struct %in% c("C4","C5"), as.integer(substr(std_struct,2,2)), as.integer(-9999)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["std_struct"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["structure_per"], graph.col=FALSE, max.distinct.values=99)
```

## layer {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, layer=1)
```

### RAWFRI

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["layer"], graph.col=FALSE, max.distinct.values=99)
```

## layer_rank {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, layer_rank=1)
```

### RAWFRI

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["layer_rank"], graph.col=FALSE, max.distinct.values=99)
```

## crown_closure {.tabset}

  * AB16 uses crownclosure rather than density that AB06 uses

```{r echo=TRUE, message=FALSE, warning=FALSE}  
friList = c('A','B','C','D')
casListLower = c(6,31,51,71)
casListUpper = c(30,50,70,100)
x = mutate(x, crown_closure_lower=if_else(crownclose==" ", -9998, as.double(mapvalues(crownclose, friList, casListLower))),
              crown_closure_upper=if_else(crownclose==" ", -9998, as.double(mapvalues(crownclose, friList, casListUpper))))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["crownclose"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["crown_closure_lower"], graph.col=FALSE, max.distinct.values=101)
```

### CASFRI (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["crown_closure_upper"], graph.col=FALSE, max.distinct.values=101)
```

## height {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, height_upper=if_else(height<1 | height>100, -9999, as.double(height)),
              height_lower=if_else(height<1 | height>100, -9999, as.double(height)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["height"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["height_lower"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["height_upper"], graph.col=FALSE, max.distinct.values=99)
```

## species_1-10 {.tabset}

  * AB06 uses sp\*\_per rather than sp\*\_percnt that AB16 uses
  * species_per_1-10 should be 1-100 not 1-10
  * The attributes species_1 - species_5 use a lookup table to translate species codes to the CASFRI standard. Here, we demonstrate the code for species_1 only since the same procedure is used for the other species.

```{r echo=TRUE, message=FALSE, warning=FALSE}  
sppList = read_csv("../../translation/tables/lookup/bc_vri01_species.csv")
x = mutate(x, species_1=case_when(
    is.na(sp1) ~ "NULL_VALUE",
    str_trim(sp1)=="" ~ "EMPTY_STRING",
    !sp1 %in% sppList$SOURCE_VAL ~ "NOT_IN_SET",
    TRUE ~ mapvalues(sp1, sppList$SOURCE_VAL, sppList$SPEC1)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["sp1"], graph.col=FALSE, max.distinct.values=99)
```
### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["species_1"], graph.col=FALSE, max.distinct.values=99)
```

## species_per_1-10 {.tabset}

  * To do: sp1_percnt ranges from 0-10 not 0-100
  * AB16 uses sp*_percnt rather than sp*_per that AB06 uses
  * The attributes species_per_1 - species_per_5 are simply copied from the attributes sp1_percnt - species_pct_6

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, species_per_1=case_when(
    is.na(sp1_percnt) ~ as.integer(-8888),
    sp1_percnt < 0 | sp1_percnt > 100 ~ as.integer(-9999),
    TRUE ~ as.integer(sp1_percnt)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["sp1_percnt"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["species_per_1"], graph.col=FALSE, max.distinct.values=99)
```

## productive_for {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
x = mutate(x, productive_for=if_else(modcon1!="CC" & species_1=="EMPTY_STRING" & (crown_closure_upper!=-9998 | height_upper!=-9999), "PP", "PF"))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x[""], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["productive_for"], graph.col=FALSE, max.distinct.values=99)
```

## origin {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}
x = mutate(x, origin_upper=if_else(origin==0,-9999,as.double(origin)),
              origin_lower=if_else(origin==0,-9999,as.double(origin)))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["origin"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI (lower)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["origin_lower"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI (upper)

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["origin_upper"], graph.col=FALSE, max.distinct.values=99)
```

## site_class {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}  
friList = c('U','F','M','G')
casList = c('U','P','M','G')
x = mutate(x, site_class=if_else(tpr==" ","NULL_VALUE", if_else(!tpr==" " & !tpr %in% friList, "NOT_IN_SET", mapvalues(tpr, friList, casList))))
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["tpr"], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["site_class"], graph.col=FALSE, max.distinct.values=99)
```

## site_index {.tabset}

```{r echo=TRUE, message=FALSE, warning=FALSE}
x = mutate(x, site_index=-8887)
```

### RAWFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
#dfSummary(x[""], graph.col=FALSE, max.distinct.values=99)
```

### CASFRI

```{r echo=FALSE, message=FALSE, warning=FALSE}  
dfSummary(x["site_index"], graph.col=FALSE, max.distinct.values=99)
```
